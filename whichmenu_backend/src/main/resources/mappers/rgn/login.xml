<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD MyBatis Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ticktick.whichmenu_backend.web.rgn.dao.OAuthTokenDAO">
  
    <!-- OAUTH 토큰 조회 -->
    <select id="findTokenByProviderUserId" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto" resultType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        SELECT 
               ID
             , PROV
             , PROV_USR_SN
             , ACC_TKN
             , REF_TKN
             , SCOPE
             , TKN_TYPE
             , EXP_AT
             , REG_DT
             , MDFCN_DT
          FROM OAUTH_TKN
         WHERE PROV          = #{prov}
           AND PROV_USR_SN   = #{usrSn}
      ORDER BY MDFCN_DT DESC
         LIMIT 1
    </select>
  
    <!-- OAUTH 토큰 업데이트 -->
    <update id="updateAccessToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        UPDATE OAUTH_TKN
           SET 
               ACC_TKN     = #{accTkn}
             , REF_TKN     = #{refTkn}
             , EXP_AT      = #{expAt}
             , MDFCN_DT    = NOW()
         WHERE ID          = #{id}
    </update>
    
    <!-- OAUTH 토큰 삽입 -->
    <insert id="insertOauthToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        INSERT 
               INTO OAUTH_TKN 
        (
               PROV
             , PROV_USR_SN
             , ACC_TKN
             , REF_TKN
             , EXP_AT
             , REG_DT
             , MDFCN_DT
        ) 
        VALUES (
               #{prov}
             , #{provUsrSn}
             , #{accTkn}
             , #{refTkn}
             , #{expAt}
             , NOW()
             , NOW()
        )
    </insert>
    
    <!-- USER 조회 -->
    <select id="findByUsrInfo" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto" resultType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto">
        SELECT 
               USR_SN
             , NICK_NM
             , EMAIL
             , PROV
             , USR_ROLE
             , REG_DT
             , MDFCN_DT
          FROM USR_INFO
         WHERE EMAIL = #{email}
    </select>
    
    <!-- USER 정보 등록 -->
    <insert id="insertUser" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto">
        INSERT 
               INTO USR_INFO 
        (
               NICK_NM
             , EMAIL
             , PROV
             , USR_ROLE
             , REG_DT
             , MDFCN_DT
        ) 
        VALUES (
               #{nickNm}
             , #{email}
             , #{prov}
             , #{usrRole}
             , NOW()
             , NOW()
        )
    </insert>
    
    <!-- 토큰 삭제 -->
    <delete  id="deleteToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        DELETE FROM OAUTH_TKN
         WHERE ID = #{id}
    </delete>
    
</mapper>