<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD MyBatis Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ticktick.whichmenu_backend.web.rgn.dao.OAuthTokenDAO">
  
    <!-- OAUTH 토큰 조회 -->
    <select id="findTokenByProviderUserId" parameterType="string" resultType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        SELECT 
               ID
             , PROVIDER
             , PROVIDER_USER_ID
             , ACCESS_TOKEN
             , REFRESH_TOKEN
             , SCOPE
             , TOKEN_TYPE
             , EXPIRES_AT
             , CREATED_AT
             , UPDATED_AT
          FROM OAUTH_TOKENS
         WHERE PROVIDER = #{provider}
           AND USER_ID  = #{providerUserId}
    </select>
  
    <!-- OAUTH 토큰 업데이트 -->
    <update id="updateAccessToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        UPDATE OAUTH_TOKENS
           SET 
               ACCESS_TOKEN     = #{accessToken}
             , REFRESH_TOKEN    = #{refreshToken}
             , EXPIRES_AT       = #{expiresAt}
             , UPDATED_AT       = NOW()
         WHERE ID               = #{id}
    </update>
    
    <!-- OAUTH 토큰 삽입 -->
    <insert id="insertOauthToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        INSERT 
               INTO OAUTH_TOKENS 
        (
               PROVIDER
             , PROVIDER_USER_ID
             , ACCESS_TOKEN
             , REFRESH_TOKEN
             , EXPIRES_AT
             , CREATED_AT
             , UPDATED_AT
        ) 
        VALUES (
               #{provider}
             , #{providerUserId}
             , #{accessToken}
             , #{refreshToken}
             , #{expiresAt}
             , NOW()
             , NOW()
        )
    </insert>
    
    <!-- USER 조회 -->
    <select id="findByUsrInfo" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto" resultType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto">
        SELECT 
               USR_SN
             , NICK_NM
             , EMAIL
             , PROV
             , USR_ROLE
             , REG_DT
             , MDFCN_DT
          FROM USR_INFO
         WHERE EMAIL = #{email}
    </select>
    
    <!-- USER 정보 등록 -->
    <insert id="insertUser" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.UsrInfoDto">
        INSERT 
               INTO USR_INFO 
        (
               NICK_NM
             , EMAIL
             , PROV
             , USR_ROLE
             , REG_DT
             , MDFCN_DT
        ) 
        VALUES (
               #{nickNm}
             , #{email}
             , #{prov}
             , #{usrRole}
             , NOW()
             , NOW()
        )
    </insert>
    
    <!-- 토큰 삭제 -->
    <delete  id="deleteToken" parameterType="com.ticktick.whichmenu_backend.web.rgn.dao.dto.OAuthToken">
        DELETE FROM OAUTH_TOKENS
         WHERE ID = #{id}
    </delete>
    
</mapper>